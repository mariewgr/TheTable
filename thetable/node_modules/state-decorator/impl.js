"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=function(r,t){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t])},e(r,t)};function r(r,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=r}e(r,t),r.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var t=function(){return t=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var o in r=arguments[t])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e},t.apply(this,arguments)};function n(e,r,t,n){return new(t||(t=Promise))((function(o,i){function c(e){try{u(n.next(e))}catch(e){i(e)}}function a(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(c,a)}u((n=n.apply(e,r||[])).next())}))}function o(e,r){var t,n,o,i,c={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(a){return function(u){return function(a){if(t)throw new TypeError("Generator is already executing.");for(;i&&(i=0,a[0]&&(c=0)),c;)try{if(t=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return c.label++,{value:a[1],done:!1};case 5:c.label++,n=a[1],a=[0];continue;case 7:a=c.ops.pop(),c.trys.pop();continue;default:if(!(o=c.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){c=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){c.label=a[1];break}if(6===a[0]&&c.label<o[1]){c.label=o[1],o=a;break}if(o&&c.label<o[2]){c.label=o[2],c.ops.push(a);break}o[2]&&c.ops.pop(),c.trys.pop();continue}a=r.call(e,c)}catch(e){a=[6,e],n=0}finally{t=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}}function i(e,r,t){if(t||2===arguments.length)for(var n,o=0,i=r.length;o<i;o++)!n&&o in r||(n||(n=Array.prototype.slice.call(r,0,o)),n[o]=r[o]);return e.concat(n||Array.prototype.slice.call(r))}"function"==typeof SuppressedError&&SuppressedError;var c,a=function(){function e(e){this.keys=e,this.adj={}}return e.prototype.isCyclicUtil=function(e,r,t){var n;if(t.has(e))return!0;if(r.has(e))return!1;r.add(e),t.add(e);for(var o=0,i=null!==(n=this.adj[e])&&void 0!==n?n:[];o<i.length;o++){var c=i[o];if(this.isCyclicUtil(c,r,t))return!0}return t.delete(e),!1},e.prototype.setEdges=function(e,r){this.adj[e]=r},e.prototype.isCyclic=function(){for(var e=new Set,r=new Set,t=0,n=this.keys;t<n.length;t++){var o=n[t];if(this.isCyclicUtil(o,e,r))return!0}return!1},e}();!function(e){e.REJECT="reject",e.IGNORE="ignore",e.KEEP_LAST="keepLast",e.KEEP_ALL="keepAll",e.PARALLEL="parallel",e.REUSE="reuse",e.ABORT="abort"}(c||(c={}));var u=function(e){function t(r,n){var o=e.call(this,r.message)||this;return o.source=r,o.initialError=n,Object.setPrototypeOf(o,t.prototype),o}return r(t,e),t}(Error),s={clone:function(e){return JSON.parse(JSON.stringify(e))},comparator:function(e,r){if(Object.is(e,r))return!0;if("object"!=typeof e||null===e||"object"!=typeof r||null===r)return!1;if(e instanceof Set||r instanceof Set)return!1;var t=Object.keys(e),n=Object.keys(r);if(t.length!==n.length)return!1;for(var o=0;o<t.length;o++)if(!Object.prototype.hasOwnProperty.call(r,t[o])||!Object.is(e[t[o]],r[t[o]]))return!1;return!0},asyncErrorHandler:function(){},retryOnErrorFunction:function(e){return e instanceof TypeError},notifySuccess:void 0,notifyError:void 0,notifyWarning:void 0,getErrorMessage:void 0,defaultMiddlewares:[]};function l(e){try{return s.clone(e)}catch(e){var r="StateDecorator: Cannot clone object. Set setCloneFunction on global global with another implementation like lodash/cloneDeep.";throw"development"===process.env.NODE_ENV&&(console.error(r),console.error(e.toString())),new Error(r)}}function f(e){return"function"!=typeof e&&!e.hasOwnProperty("getPromise")&&e.hasOwnProperty("getGetPromise")}function d(e,r,n,o){var i,c,a,u;return t(t({},e),o?((i={})[r]=t(t({},e[r]||{}),((c={})[n]=o,c)),i):((a={})[r]=t(t({},e[r]),((u={})[n]=!1,u)),a))}function p(e,r,n,o){var i,c,a,u;return t(t({},e),o?((i={})[r]=t(t({},e[r]||{}),((c={})[n]=o,c)),i):((a={})[r]=t(t({},e[r]),((u={})[n]=void 0,u)),a))}var v=function(e){function t(r){var n=e.call(this,"Error")||this;return n.promiseIds=r,Object.setPrototypeOf(n,t.prototype),n}return r(t,e),t}(Error);function y(e,r,t,i){return void 0===r&&(r=1),void 0===t&&(t=1e3),void 0===i&&(i=function(){return!0}),1===r?e:function(c){var a=e(c);return null===a?null:function a(u,s){return n(this,void 0,void 0,(function(){return o(this,(function(n){return null===s?[2,null]:[2,s.catch((function(n){return i(n)?u===r?Promise.reject(n):new Promise((function(r,n){setTimeout((function(){var t=e(c);a(u+1,t).then(r).catch(n)}),t*u)})):Promise.reject(n)}))]}))}))}(1,a)}}function g(e){return void 0===e&&(e=null),{current:e}}function h(e,r,t){var n,o;return{state:e.current,s:e.current,ds:null===(n=null==r?void 0:r.current)||void 0===n?void 0:n.state,derived:null===(o=null==r?void 0:r.current)||void 0===o?void 0:o.state,props:t.current,p:t.current}}function E(e,r,t,n,o,i,c){var a=h(e,r,t);return a.indices=n,a.index=o,a.isInit=i,a.getInitialState=c,a}function S(e,r,t,n,o){var i=h(e,r,t);return i.args=n,o&&(i.promiseId=o),i}function P(e,r,t,n,o,i){var c=S(e,r,t,n,i);return c.result=o,c.res=o,c}function m(e,r){var t=e;return t.state=r.current,t.s=r.current,t}function b(e,r){var t=e;return t.actions=r.current,t.a=r.current,t}function w(e,r,t,n,o,i){var c,a=b(e,n);m(e,r);var u=null===(c=null==t?void 0:t.current)||void 0===c?void 0:c.state;return a.derived=u,a.ds=u,a.notifyWarning=o,a.clearError=i,a}function x(e){"development"===process.env.NODE_ENV&&console.warn("[state-decorator] ".concat(e," action was called while store is not initialized or destroyed, this is probably a leak"))}function A(e,r,n){return n?r:null==r?null:t(t({},e.current),r)}function O(e,r,t,n,o,i,c,a,u,s,l,f){var d,p=P(t,n,o,f,void 0),v=!1;if(null!=r.effects){var y=A(t,r.effects(p),u.fullStateEffects);null===y?v=!0:s(y,void 0,e,"effects",!1,p,!1)}if(!v)if(r.debounceSideEffectsTimeout>0){var g=c.current[e];g&&clearTimeout(g),c.current[e]=setTimeout((function(){var o;a.current&&(null===(o=r.sideEffects)||void 0===o||o.call(r,w(p,t,n,i,u.notifyWarning,l)),delete c.current[e])}),r.debounceSideEffectsTimeout)}else null===(d=r.sideEffects)||void 0===d||d.call(r,w(p,t,n,i,u.notifyWarning,l))}function R(e,r,t,n){var o=e.action,i=e.stateRef,c=e.derivedStateRef,a=e.propsRef,l=e.actionsRef,f=e.loadingParallelMapRef,v=e.errorMapRef,y=e.promisesRef,g=e.conflictActionsRef,h=e.actionName,E=e.options,P=e.clearError,m=e.setState;if(e.initializedRef.current){var b=null,x=t,O=function(e,r,t,n,o,i){var c=S(e,r,t,n,i);return c.error=o,c.err=o,c}(i,c,a,n,x,r);if(o.errorEffects)try{b=A(i,o.errorEffects(O),E.fullStateEffects)}catch(e){x=new u(e,t)}v.current=p(v.current,h,r,x),m(b,d(f.current,h,r,!1),h,"errorEffects",!0,O,!1);var R=!1;(null!=b||o.errorSideEffects||o.isErrorManaged||E.isErrorManaged)&&(R=!0);var C=E.notifyError||s.notifyError;if(C){var j=void 0;o.getErrorMessage&&(j=o.getErrorMessage(O)),void 0===j&&!R&&s.getErrorMessage&&(j=s.getErrorMessage(x)),j&&(R=!0,C(j))}return s.asyncErrorHandler(x,R||o.rejectPromiseOnError,i.current,a.current,h,n),delete y.current[h][r],o.errorSideEffects&&o.errorSideEffects(w(O,i,c,l,s.notifyWarning,P)),L(e.initializedRef,h,l.current,g.current),!R||o.rejectPromiseOnError?Promise.reject(x):Promise.resolve()}}var C="__def__";function j(e,r){return e.length===r.length&&-1===e.findIndex((function(e,t){return r[t]!==e}))}function L(e,r,t,n){if(e.current){var o=n[r];if((null==o?void 0:o.length)>0){var i=o.shift();if(i){var c=t[r].apply(t,i.args);null==c?L(e,r,t,n):c.then((function(o){null===o&&L(e,r,t,n),i.resolve(o)})).catch((function(e){return i.reject(e)}))}}}}exports.DEFAULT_PROMISE_ID=C,exports.EffectError=u,exports.ParallelActionError=v,exports.addContextActions=b,exports.addStateToContext=m,exports.areSameArgs=j,exports.buildErrorMap=function(e){return Object.keys(e).reduce((function(r,t){var n=e[t];if(null==n[C]);else if(n[C])r[t]=n[C];else{var o=Object.keys(n).reduce((function(e,r){return null!=n[r]&&(e.hasErr=!0,e.map[r]=n[r]),e}),{hasErr:!1,map:{}});o.hasErr&&(r[t]=new v(o.map))}return r}),{})},exports.buildInvocationContextBase=h,exports.buildLoadingMap=d,exports.buildOnMountInvocationContext=function(e,r,t,n){return b(h(e,r,t),n)},exports.buildOnPropChangeEffects=E,exports.buildOnUnMountInvocationContext=function(e,r,n,o){return t(t({},h(e,r,n)),{abortedActions:o})},exports.computeAsyncActionInput=function(e){return e.conflictPolicy===c.ABORT&&(e.abortable=!0),f(e)?t(t({},e),{getPromise:e.getGetPromise,retryCount:3,conflictPolicy:c.REUSE}):e},exports.computeDerivedValues=function(e,r,n,o){if(null==(null==o?void 0:o.derivedState))return!1;var i=!1,c=s.comparator,a=n.current.deps,u=h(e,null,r),l=Object.keys(o.derivedState);return n.current.state=l.reduce((function(e,r){var s,l,f=!1,d=o.derivedState[r],p=a[r],v=null!==(l=null===(s=d.getDeps)||void 0===s?void 0:s.call(d,u))&&void 0!==l?l:[];(d.derivedDeps&&d.derivedDeps.forEach((function(r){var t,o,i;return v.push(null!==(t=e[r])&&void 0!==t?t:null===(i=null===(o=n.current)||void 0===o?void 0:o.state)||void 0===i?void 0:i[r])})),null==p)?f=!0:f=-1!==v.findIndex((function(e,r){return p.length<r||!c(p[r],e)}));return i=i||f,a[r]=v,e[r]=f?o.derivedState[r].get(function(e,r){return t(t({},e),{ds:r,derived:r})}(u,e)):n.current.state[r],e}),{}),i},exports.createRef=g,exports.decorateAsyncAction=function(e){var r=e.action,n=e.stateRef,o=e.derivedStateRef,a=e.propsRef,f=e.actionsRef,v=e.promisesRef,g=e.loadingParallelMapRef,h=e.errorMapRef,E=e.initializedRef,m=e.conflictActionsRef,O=e.actionName,M=e.setState,_=e.options;return function(){for(var T,k,D,I=[],G=0;G<arguments.length;G++)I[G]=arguments[G];if(!E.current)return x(O),null;var N=v.current,U=r.conflictPolicy,z=void 0===U?c.KEEP_ALL:U,F=z===c.PARALLEL,K=null;if(F){if(!r.getPromiseId)throw new Error("If conflict policy is set to ConflictPolicy.PARALLEL, getPromiseId must be set and return a string.");K=r.getPromiseId.apply(r,I)}else K=C;if(!F&&(null===(k=N[O])||void 0===k?void 0:k[K])){var W=function(e,r,t,n,o){var i=n;if(i===c.REUSE){if(j(e[t][C].refArgs,o))return e[t][C].promise;i=c.KEEP_ALL}return new Promise((function(n,a){var u,s={resolve:n,reject:a,args:l(o),timestamp:Date.now()};switch(i){case c.IGNORE:n(void 0);break;case c.REJECT:a(new Error("An asynchronous action ".concat(t," is already ongoing.")));break;case c.KEEP_LAST:r[t]=[s];break;case c.ABORT:var f=null===(u=e[t][C])||void 0===u?void 0:u.abortController;null==f||f.abort("conflict");case c.KEEP_ALL:var d=r[t];d||(r[t]=d=[]),d.push(s);case c.PARALLEL:case c.REUSE:}}))}(N,m.current,O,z,I);return W}var B=null,J=!1,H=S(n,o,a,I,K);if(r.preEffects){try{B=A(n,r.preEffects(H),_.fullStateEffects)}catch(e){return s.asyncErrorHandler(new u(e),!1,n.current,a.current,O,I),Promise.reject(new u(e))}B&&(J=!0,n.current=B)}var V=r.abortable,q=r.retryCount,Q=r.retryDelaySeed,X=r.isTriggerRetryError,Y=V&&window.AbortController?new AbortController:null,Z=null===(D=y(r.getPromise,q?1+q:1,Q,X||s.retryOnErrorFunction)(function(e,r,t,n,o,i,c){var a=b(S(e,r,t,n,c),o);return a.abortSignal=i,a}(n,o,a,I,f,null==Y?void 0:Y.signal)))||void 0===D?void 0:D.then((function(r){return function(e,r,t,n){var o=e.action,i=e.stateRef,c=e.derivedStateRef,a=e.propsRef,l=e.promisesRef,f=e.actionsRef,p=e.loadingParallelMapRef,v=e.conflictActionsRef,y=e.actionName,g=e.options,h=e.setState,E=e.clearError;if(e.initializedRef.current){var S=null,m=P(i,c,a,n,t,r);if(o.effects)try{S=A(i,o.effects(m),g.fullStateEffects)}catch(e){return Promise.reject(new u(e))}h(S,d(p.current,y,r,!1),y,"effects",!0,m,!1);var b=g.notifySuccess||s.notifySuccess;if(b){var x=void 0;o.getSuccessMessage&&(x=o.getSuccessMessage(m)),x&&b(x)}return delete l.current[y][r],o.sideEffects&&o.sideEffects(w(m,i,c,f,s.notifyWarning,E)),L(e.initializedRef,y,f.current,v.current),t}}(e,K,r,I)})).catch((function(r){return R(e,K,r,I)}));return null!=Z&&(N[O]=t(t({},N[O]||{}),((T={})[K||C]={abortController:Y,promise:Z,refArgs:z===c.REUSE&&I.length>0?i([],I,!0):[]},T))),h.current=p(h.current,O,K,null),M(null!=Z||J?n.current:void 0,null==Z?void 0:d(g.current,O,K,!0),O,"preEffects",!0,H,!1),Z}},exports.decorateSimpleSyncAction=function(e,r,t,n,o,i,c,a){return function(){for(var u=[],s=0;s<arguments.length;s++)u[s]=arguments[s];if(i.current){var l=S(t,n,o,u),f=A(t,r(l),c.fullStateEffects);a(f,null,e,"effects",!1,l,!1)}else x(e)}},exports.decorateSyncAction=function(e,r,t,n,o,i,c,a,u,s,l){return function(){for(var f=[],d=0;d<arguments.length;d++)f[d]=arguments[d];if(c.current)if(r.debounceTimeout){var p=a.current[e];p&&clearTimeout(p),a.current[e]=setTimeout((function(){c.current&&(delete a.current[e],O(e,r,t,n,o,i,a,c,u,s,l,f))}),r.debounceTimeout)}else O(e,r,t,n,o,i,a,c,u,s,l,f);else x(e)}},exports.fixDerivedDeps=function(e){var r,t=Object.keys(e.derivedState),n=new a(t);if(t.forEach((function(r){n.setEdges(r,e.derivedState[r].derivedDeps)})),n.isCyclic())throw new Error("There are cycles in the derived state dependencies");for(var o=!1,i={},c=0,u=t;c<u.length;c++){var s=u[c],l=null!==(r=e.derivedState[s].derivedDeps)&&void 0!==r?r:[];o=o||l.length>0,i[s]=l.concat()}if(o){t.sort((function(e,r){return i[e].length-i[r].length}));for(var f=[],d=new Set,p=t.length;d.size!==p;){var v=t.pop();if(!d.has(v))i[v]=i[v].filter((function(e){return!d.has(e)})),0===i[v].length?(f.push(v),d.add(v)):t.splice(0,0,v)}for(var y={},g=0,h=f;g<h.length;g++){y[v=h[g]]=e.derivedState[v]}e.derivedState=y}},exports.globalConfig=s,exports.isAsyncAction=function(e){return!(e instanceof Function)&&(e.hasOwnProperty("getPromise")||e.hasOwnProperty("getGetPromise"))},exports.isAsyncGetPromiseAction=function(e){return"function"!=typeof e&&e.hasOwnProperty("getPromise")&&!e.hasOwnProperty("getGetPromise")},exports.isAsyncGetPromiseGetAction=f,exports.isFuncConfig=function(e){return e.hasOwnProperty("getInitialState")},exports.isLoadingImpl=function(e){for(var r=[],t=1;t<arguments.length;t++)r[t-1]=arguments[t];return r.some((function(r){var t,n=null,o=C;Array.isArray(r)?(n=r[0],o=void 0===(t=r[1])?C:t):n=r;var i=e[n];return null!=i&&(null!=i[o]&&i[o])}))},exports.isSimpleSyncAction=function(e){return"function"==typeof e},exports.isSyncAction=function(e){return"function"!=typeof e&&!e.hasOwnProperty("getPromise")&&!e.hasOwnProperty("getGetPromise")},exports.onPropChange=function(e,r,n,o,i,c,a,u,l,f){var d=null!=(null==c?void 0:c.derivedState);if(null!=c.onPropsChange){var p;p=Array.isArray(c.onPropsChange)?c.onPropsChange:[c.onPropsChange];var v=!1,y=g(e.current),h=[],S=s.comparator;p.forEach((function(t,i){var s,d=t.getDeps;if(d){var p=!1,g=[];if(l){if(!(!f&&t.onMount||f&&t.onMountDeferred))return;p=!0}else{var P=d(o),m=d(n.current);P.length!==m.length?(console.warn("options.onPropsChange.getDeps returned array must be stable (same length)"),p=!0):P.forEach((function(e,r){S(e,m[r])||(p=!0,g.push(r))}))}if(p){var b=E(y,r,n,g,i,l,a),w=A(e,null===(s=t.effects)||void 0===s?void 0:s.call(t,b),c.fullStateEffects);null!=w&&(v=!0,y.current=w,u(y.current,void 0,"onPropsChange","effects",!1,b,!0,l)),t.sideEffects&&h.push({index:i,indices:g,ctx:b})}}})),!v&&d&&u(void 0,void 0,"onPropsChange","effects",!1,null,!0),h.length>0&&h.forEach((function(e){p[e.index].sideEffects(t(t({},m(b(e.ctx,i),y)),{indices:e.indices}))}))}else null!=(null==c?void 0:c.derivedState)&&u(void 0,void 0,"onPropsChange","effects",!1,null,!0)},exports.retryPromiseDecorator=y,exports.runMiddlewares=function(e,r,t,n,o,i,c,a){if("onPropsChange"===o&&void 0===t)return{newState:null,newLoading:!1};if(e&&e.length>0){var u=e.reduce((function(e,r){var t=r.effects({isAsync:c,name:o,type:i,context:a},e.oldState,e.newState,n);return{newState:(null==t?void 0:t.state)||e.newState,oldState:(null==t?void 0:t.state)?e.newState:e.oldState,loading:null==(null==t?void 0:t.loading)?e.loading:t.loading}}),{oldState:r,newState:t,loading:n});return{newLoading:u.loading,newState:u.newState}}return{newState:t,newLoading:n}},exports.setGlobalConfig=function(e){Object.keys(e).forEach((function(r){null!=e[r]&&(s[r]=e[r])}))},exports.updateErrorMap=p;
//# sourceMappingURL=impl.js.map
