var e=function(r,t){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t])},e(r,t)};function r(r,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=r}e(r,t),r.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var t=function(){return t=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var o in r=arguments[t])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e},t.apply(this,arguments)};function n(e,r,t,n){return new(t||(t=Promise))((function(o,i){function c(e){try{a(n.next(e))}catch(e){i(e)}}function u(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(c,u)}a((n=n.apply(e,r||[])).next())}))}function o(e,r){var t,n,o,i,c={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(u){return function(a){return function(u){if(t)throw new TypeError("Generator is already executing.");for(;i&&(i=0,u[0]&&(c=0)),c;)try{if(t=1,n&&(o=2&u[0]?n.return:u[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,u[1])).done)return o;switch(n=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return c.label++,{value:u[1],done:!1};case 5:c.label++,n=u[1],u=[0];continue;case 7:u=c.ops.pop(),c.trys.pop();continue;default:if(!(o=c.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){c=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){c.label=u[1];break}if(6===u[0]&&c.label<o[1]){c.label=o[1],o=u;break}if(o&&c.label<o[2]){c.label=o[2],c.ops.push(u);break}o[2]&&c.ops.pop(),c.trys.pop();continue}u=r.call(e,c)}catch(e){u=[6,e],n=0}finally{t=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}}function i(e,r,t){if(t||2===arguments.length)for(var n,o=0,i=r.length;o<i;o++)!n&&o in r||(n||(n=Array.prototype.slice.call(r,0,o)),n[o]=r[o]);return e.concat(n||Array.prototype.slice.call(r))}"function"==typeof SuppressedError&&SuppressedError;var c,u=function(){function e(e){this.keys=e,this.adj={}}return e.prototype.isCyclicUtil=function(e,r,t){var n;if(t.has(e))return!0;if(r.has(e))return!1;r.add(e),t.add(e);for(var o=0,i=null!==(n=this.adj[e])&&void 0!==n?n:[];o<i.length;o++){var c=i[o];if(this.isCyclicUtil(c,r,t))return!0}return t.delete(e),!1},e.prototype.setEdges=function(e,r){this.adj[e]=r},e.prototype.isCyclic=function(){for(var e=new Set,r=new Set,t=0,n=this.keys;t<n.length;t++){var o=n[t];if(this.isCyclicUtil(o,e,r))return!0}return!1},e}();!function(e){e.REJECT="reject",e.IGNORE="ignore",e.KEEP_LAST="keepLast",e.KEEP_ALL="keepAll",e.PARALLEL="parallel",e.REUSE="reuse",e.ABORT="abort"}(c||(c={}));var a=function(e){function t(r,n){var o=e.call(this,r.message)||this;return o.source=r,o.initialError=n,Object.setPrototypeOf(o,t.prototype),o}return r(t,e),t}(Error),l={clone:function(e){return JSON.parse(JSON.stringify(e))},comparator:function(e,r){if(Object.is(e,r))return!0;if("object"!=typeof e||null===e||"object"!=typeof r||null===r)return!1;if(e instanceof Set||r instanceof Set)return!1;var t=Object.keys(e),n=Object.keys(r);if(t.length!==n.length)return!1;for(var o=0;o<t.length;o++)if(!Object.prototype.hasOwnProperty.call(r,t[o])||!Object.is(e[t[o]],r[t[o]]))return!1;return!0},asyncErrorHandler:function(){},retryOnErrorFunction:function(e){return e instanceof TypeError},notifySuccess:void 0,notifyError:void 0,notifyWarning:void 0,getErrorMessage:void 0,defaultMiddlewares:[]};function f(e){Object.keys(e).forEach((function(r){null!=e[r]&&(l[r]=e[r])}))}function s(e){try{return l.clone(e)}catch(e){var r="StateDecorator: Cannot clone object. Set setCloneFunction on global global with another implementation like lodash/cloneDeep.";throw"development"===process.env.NODE_ENV&&(console.error(r),console.error(e.toString())),new Error(r)}}function d(e){return!(e instanceof Function)&&(e.hasOwnProperty("getPromise")||e.hasOwnProperty("getGetPromise"))}function v(e){return"function"==typeof e}function p(e){return"function"!=typeof e&&!e.hasOwnProperty("getPromise")&&!e.hasOwnProperty("getGetPromise")}function h(e){return"function"!=typeof e&&e.hasOwnProperty("getPromise")&&!e.hasOwnProperty("getGetPromise")}function g(e){return"function"!=typeof e&&!e.hasOwnProperty("getPromise")&&e.hasOwnProperty("getGetPromise")}function y(e){return e.conflictPolicy===c.ABORT&&(e.abortable=!0),g(e)?t(t({},e),{getPromise:e.getGetPromise,retryCount:3,conflictPolicy:c.REUSE}):e}function E(e,r,n,o){var i,c,u,a;return t(t({},e),o?((i={})[r]=t(t({},e[r]||{}),((c={})[n]=o,c)),i):((u={})[r]=t(t({},e[r]),((a={})[n]=!1,a)),u))}function S(e,r,n,o){var i,c,u,a;return t(t({},e),o?((i={})[r]=t(t({},e[r]||{}),((c={})[n]=o,c)),i):((u={})[r]=t(t({},e[r]),((a={})[n]=void 0,a)),u))}var w=function(e){function t(r){var n=e.call(this,"Error")||this;return n.promiseIds=r,Object.setPrototypeOf(n,t.prototype),n}return r(t,e),t}(Error);function P(e){return Object.keys(e).reduce((function(r,t){var n=e[t];if(null==n[W]);else if(n[W])r[t]=n[W];else{var o=Object.keys(n).reduce((function(e,r){return null!=n[r]&&(e.hasErr=!0,e.map[r]=n[r]),e}),{hasErr:!1,map:{}});o.hasErr&&(r[t]=new w(o.map))}return r}),{})}function m(e,r,t,i){return void 0===r&&(r=1),void 0===t&&(t=1e3),void 0===i&&(i=function(){return!0}),1===r?e:function(c){var u=e(c);return null===u?null:function u(a,l){return n(this,void 0,void 0,(function(){return o(this,(function(n){return null===l?[2,null]:[2,l.catch((function(n){return i(n)?a===r?Promise.reject(n):new Promise((function(r,n){setTimeout((function(){var t=e(c);u(a+1,t).then(r).catch(n)}),t*a)})):Promise.reject(n)}))]}))}))}(1,u)}}function b(e){return void 0===e&&(e=null),{current:e}}function O(e,r,t){var n,o;return{state:e.current,s:e.current,ds:null===(n=null==r?void 0:r.current)||void 0===n?void 0:n.state,derived:null===(o=null==r?void 0:r.current)||void 0===o?void 0:o.state,props:t.current,p:t.current}}function R(e,r,t,n){return k(O(e,r,t),n)}function A(e,r,n,o){return t(t({},O(e,r,n)),{abortedActions:o})}function j(e,r,t,n,o,i,c){var u=O(e,r,t);return u.indices=n,u.index=o,u.isInit=i,u.getInitialState=c,u}function C(e,r,t,n,o){var i=O(e,r,t);return i.args=n,o&&(i.promiseId=o),i}function L(e,r,t,n,o,i){var c=C(e,r,t,n,i);return c.result=o,c.res=o,c}function T(e,r){var t=e;return t.state=r.current,t.s=r.current,t}function k(e,r){var t=e;return t.actions=r.current,t.a=r.current,t}function _(e,r,t,n,o,i){var c,u=k(e,n);T(e,r);var a=null===(c=null==t?void 0:t.current)||void 0===c?void 0:c.state;return u.derived=a,u.ds=a,u.notifyWarning=o,u.clearError=i,u}function M(e){"development"===process.env.NODE_ENV&&console.warn("[state-decorator] ".concat(e," action was called while store is not initialized or destroyed, this is probably a leak"))}function x(e,r,n){return n?r:null==r?null:t(t({},e.current),r)}function D(e){return e.hasOwnProperty("getInitialState")}function I(e,r,t,n,o,i,c,u){return function(){for(var a=[],l=0;l<arguments.length;l++)a[l]=arguments[l];if(i.current){var f=C(t,n,o,a),s=x(t,r(f),c.fullStateEffects);u(s,null,e,"effects",!1,f,!1)}else M(e)}}function N(e,r,t,n,o,i,c,u,a,l,f,s){var d,v=L(t,n,o,s,void 0),p=!1;if(null!=r.effects){var h=x(t,r.effects(v),a.fullStateEffects);null===h?p=!0:l(h,void 0,e,"effects",!1,v,!1)}if(!p)if(r.debounceSideEffectsTimeout>0){var g=c.current[e];g&&clearTimeout(g),c.current[e]=setTimeout((function(){var o;u.current&&(null===(o=r.sideEffects)||void 0===o||o.call(r,_(v,t,n,i,a.notifyWarning,f)),delete c.current[e])}),r.debounceSideEffectsTimeout)}else null===(d=r.sideEffects)||void 0===d||d.call(r,_(v,t,n,i,a.notifyWarning,f))}function G(e,r,t,n,o,i,c,u,a,l,f){return function(){for(var s=[],d=0;d<arguments.length;d++)s[d]=arguments[d];if(c.current)if(r.debounceTimeout){var v=u.current[e];v&&clearTimeout(v),u.current[e]=setTimeout((function(){c.current&&(delete u.current[e],N(e,r,t,n,o,i,u,c,a,l,f,s))}),r.debounceTimeout)}else N(e,r,t,n,o,i,u,c,a,l,f,s);else M(e)}}function U(e,r,t,n){var o=e.action,i=e.stateRef,c=e.derivedStateRef,u=e.propsRef,f=e.actionsRef,s=e.loadingParallelMapRef,d=e.errorMapRef,v=e.promisesRef,p=e.conflictActionsRef,h=e.actionName,g=e.options,y=e.clearError,w=e.setState;if(e.initializedRef.current){var P=null,m=t,b=function(e,r,t,n,o,i){var c=C(e,r,t,n,i);return c.error=o,c.err=o,c}(i,c,u,n,m,r);if(o.errorEffects)try{P=x(i,o.errorEffects(b),g.fullStateEffects)}catch(e){m=new a(e,t)}d.current=S(d.current,h,r,m),w(P,E(s.current,h,r,!1),h,"errorEffects",!0,b,!1);var O=!1;(null!=P||o.errorSideEffects||o.isErrorManaged||g.isErrorManaged)&&(O=!0);var R=g.notifyError||l.notifyError;if(R){var A=void 0;o.getErrorMessage&&(A=o.getErrorMessage(b)),void 0===A&&!O&&l.getErrorMessage&&(A=l.getErrorMessage(m)),A&&(O=!0,R(A))}return l.asyncErrorHandler(m,O||o.rejectPromiseOnError,i.current,u.current,h,n),delete v.current[h][r],o.errorSideEffects&&o.errorSideEffects(_(b,i,c,f,l.notifyWarning,y)),J(e.initializedRef,h,f.current,p.current),!O||o.rejectPromiseOnError?Promise.reject(m):Promise.resolve()}}function z(e){var r=e.action,n=e.stateRef,o=e.derivedStateRef,u=e.propsRef,f=e.actionsRef,d=e.promisesRef,v=e.loadingParallelMapRef,p=e.errorMapRef,h=e.initializedRef,g=e.conflictActionsRef,y=e.actionName,w=e.setState,P=e.options;return function(){for(var b,O,R,A=[],j=0;j<arguments.length;j++)A[j]=arguments[j];if(!h.current)return M(y),null;var T=d.current,D=r.conflictPolicy,I=void 0===D?c.KEEP_ALL:D,N=I===c.PARALLEL,G=null;if(N){if(!r.getPromiseId)throw new Error("If conflict policy is set to ConflictPolicy.PARALLEL, getPromiseId must be set and return a string.");G=r.getPromiseId.apply(r,A)}else G=W;if(!N&&(null===(O=T[y])||void 0===O?void 0:O[G])){var z=function(e,r,t,n,o){var i=n;if(i===c.REUSE){if(F(e[t][W].refArgs,o))return e[t][W].promise;i=c.KEEP_ALL}return new Promise((function(n,u){var a,l={resolve:n,reject:u,args:s(o),timestamp:Date.now()};switch(i){case c.IGNORE:n(void 0);break;case c.REJECT:u(new Error("An asynchronous action ".concat(t," is already ongoing.")));break;case c.KEEP_LAST:r[t]=[l];break;case c.ABORT:var f=null===(a=e[t][W])||void 0===a?void 0:a.abortController;null==f||f.abort("conflict");case c.KEEP_ALL:var d=r[t];d||(r[t]=d=[]),d.push(l);case c.PARALLEL:case c.REUSE:}}))}(T,g.current,y,I,A);return z}var K=null,B=!1,H=C(n,o,u,A,G);if(r.preEffects){try{K=x(n,r.preEffects(H),P.fullStateEffects)}catch(e){return l.asyncErrorHandler(new a(e),!1,n.current,u.current,y,A),Promise.reject(new a(e))}K&&(B=!0,n.current=K)}var V=r.abortable,q=r.retryCount,Q=r.retryDelaySeed,X=r.isTriggerRetryError,Y=V&&window.AbortController?new AbortController:null,Z=null===(R=m(r.getPromise,q?1+q:1,Q,X||l.retryOnErrorFunction)(function(e,r,t,n,o,i,c){var u=k(C(e,r,t,n,c),o);return u.abortSignal=i,u}(n,o,u,A,f,null==Y?void 0:Y.signal)))||void 0===R?void 0:R.then((function(r){return function(e,r,t,n){var o=e.action,i=e.stateRef,c=e.derivedStateRef,u=e.propsRef,f=e.promisesRef,s=e.actionsRef,d=e.loadingParallelMapRef,v=e.conflictActionsRef,p=e.actionName,h=e.options,g=e.setState,y=e.clearError;if(e.initializedRef.current){var S=null,w=L(i,c,u,n,t,r);if(o.effects)try{S=x(i,o.effects(w),h.fullStateEffects)}catch(e){return Promise.reject(new a(e))}g(S,E(d.current,p,r,!1),p,"effects",!0,w,!1);var P=h.notifySuccess||l.notifySuccess;if(P){var m=void 0;o.getSuccessMessage&&(m=o.getSuccessMessage(w)),m&&P(m)}return delete f.current[p][r],o.sideEffects&&o.sideEffects(_(w,i,c,s,l.notifyWarning,y)),J(e.initializedRef,p,s.current,v.current),t}}(e,G,r,A)})).catch((function(r){return U(e,G,r,A)}));return null!=Z&&(T[y]=t(t({},T[y]||{}),((b={})[G||W]={abortController:Y,promise:Z,refArgs:I===c.REUSE&&A.length>0?i([],A,!0):[]},b))),p.current=S(p.current,y,G,null),w(null!=Z||B?n.current:void 0,null==Z?void 0:E(v.current,y,G,!0),y,"preEffects",!0,H,!1),Z}}function K(e){for(var r=[],t=1;t<arguments.length;t++)r[t-1]=arguments[t];return r.some((function(r){var t,n=null,o=W;Array.isArray(r)?(n=r[0],o=void 0===(t=r[1])?W:t):n=r;var i=e[n];return null!=i&&(null!=i[o]&&i[o])}))}var W="__def__";function F(e,r){return e.length===r.length&&-1===e.findIndex((function(e,t){return r[t]!==e}))}function J(e,r,t,n){if(e.current){var o=n[r];if((null==o?void 0:o.length)>0){var i=o.shift();if(i){var c=t[r].apply(t,i.args);null==c?J(e,r,t,n):c.then((function(o){null===o&&J(e,r,t,n),i.resolve(o)})).catch((function(e){return i.reject(e)}))}}}}function B(e,r,n,o){if(null==(null==o?void 0:o.derivedState))return!1;var i=!1,c=l.comparator,u=n.current.deps,a=O(e,null,r),f=Object.keys(o.derivedState);return n.current.state=f.reduce((function(e,r){var l,f,s=!1,d=o.derivedState[r],v=u[r],p=null!==(f=null===(l=d.getDeps)||void 0===l?void 0:l.call(d,a))&&void 0!==f?f:[];(d.derivedDeps&&d.derivedDeps.forEach((function(r){var t,o,i;return p.push(null!==(t=e[r])&&void 0!==t?t:null===(i=null===(o=n.current)||void 0===o?void 0:o.state)||void 0===i?void 0:i[r])})),null==v)?s=!0:s=-1!==p.findIndex((function(e,r){return v.length<r||!c(v[r],e)}));return i=i||s,u[r]=p,e[r]=s?o.derivedState[r].get(function(e,r){return t(t({},e),{ds:r,derived:r})}(a,e)):n.current.state[r],e}),{}),i}function H(e){var r,t=Object.keys(e.derivedState),n=new u(t);if(t.forEach((function(r){n.setEdges(r,e.derivedState[r].derivedDeps)})),n.isCyclic())throw new Error("There are cycles in the derived state dependencies");for(var o=!1,i={},c=0,a=t;c<a.length;c++){var l=a[c],f=null!==(r=e.derivedState[l].derivedDeps)&&void 0!==r?r:[];o=o||f.length>0,i[l]=f.concat()}if(o){t.sort((function(e,r){return i[e].length-i[r].length}));for(var s=[],d=new Set,v=t.length;d.size!==v;){var p=t.pop();if(!d.has(p))i[p]=i[p].filter((function(e){return!d.has(e)})),0===i[p].length?(s.push(p),d.add(p)):t.splice(0,0,p)}for(var h={},g=0,y=s;g<y.length;g++){h[p=y[g]]=e.derivedState[p]}e.derivedState=h}}function V(e,r,n,o,i,c,u,a,f,s){var d=null!=(null==c?void 0:c.derivedState);if(null!=c.onPropsChange){var v;v=Array.isArray(c.onPropsChange)?c.onPropsChange:[c.onPropsChange];var p=!1,h=b(e.current),g=[],y=l.comparator;v.forEach((function(t,i){var l,d=t.getDeps;if(d){var v=!1,E=[];if(f){if(!(!s&&t.onMount||s&&t.onMountDeferred))return;v=!0}else{var S=d(o),w=d(n.current);S.length!==w.length?(console.warn("options.onPropsChange.getDeps returned array must be stable (same length)"),v=!0):S.forEach((function(e,r){y(e,w[r])||(v=!0,E.push(r))}))}if(v){var P=j(h,r,n,E,i,f,u),m=x(e,null===(l=t.effects)||void 0===l?void 0:l.call(t,P),c.fullStateEffects);null!=m&&(p=!0,h.current=m,a(h.current,void 0,"onPropsChange","effects",!1,P,!0,f)),t.sideEffects&&g.push({index:i,indices:E,ctx:P})}}})),!p&&d&&a(void 0,void 0,"onPropsChange","effects",!1,null,!0),g.length>0&&g.forEach((function(e){v[e.index].sideEffects(t(t({},T(k(e.ctx,i),h)),{indices:e.indices}))}))}else null!=(null==c?void 0:c.derivedState)&&a(void 0,void 0,"onPropsChange","effects",!1,null,!0)}function q(e,r,t,n,o,i,c,u){if("onPropsChange"===o&&void 0===t)return{newState:null,newLoading:!1};if(e&&e.length>0){var a=e.reduce((function(e,r){var t=r.effects({isAsync:c,name:o,type:i,context:u},e.oldState,e.newState,n);return{newState:(null==t?void 0:t.state)||e.newState,oldState:(null==t?void 0:t.state)?e.newState:e.oldState,loading:null==(null==t?void 0:t.loading)?e.loading:t.loading}}),{oldState:r,newState:t,loading:n});return{newLoading:a.loading,newState:a.newState}}return{newState:t,newLoading:n}}export{W as DEFAULT_PROMISE_ID,a as EffectError,w as ParallelActionError,k as addContextActions,T as addStateToContext,F as areSameArgs,P as buildErrorMap,O as buildInvocationContextBase,E as buildLoadingMap,R as buildOnMountInvocationContext,j as buildOnPropChangeEffects,A as buildOnUnMountInvocationContext,y as computeAsyncActionInput,B as computeDerivedValues,b as createRef,z as decorateAsyncAction,I as decorateSimpleSyncAction,G as decorateSyncAction,H as fixDerivedDeps,l as globalConfig,d as isAsyncAction,h as isAsyncGetPromiseAction,g as isAsyncGetPromiseGetAction,D as isFuncConfig,K as isLoadingImpl,v as isSimpleSyncAction,p as isSyncAction,V as onPropChange,m as retryPromiseDecorator,q as runMiddlewares,f as setGlobalConfig,S as updateErrorMap};
//# sourceMappingURL=impl.js.map
